# AVR 编程 02:硬件

> 原文:[https://hack aday . com/2010/10/25/AVR-programming-02-the-hardware/](https://hackaday.com/2010/10/25/avr-programming-02-the-hardware/)

你也许可以写出嵌入式系统历史上最精彩的代码，但是如果没有在硬件上运行的方法，它将毫无价值。在本系列教程中，我们将:

*   看看一些可用的 AVR 编程器选项
*   将微控制器放在试验板上，并将其连接到电源和编程器。
*   使用编程软件向微控制器发送一些示例代码

如果你错过了第一部分,请花几分钟时间回顾这部分教程，然后在休息后加入我们。

**系列路线图:**

*   [AVR 编程 01:简介](http://hackaday.com/2010/10/23/avr-programming-introduction/ "Permanent Link to AVR Programming 01: Introduction")
*   [AVR 编程 02:硬件](http://hackaday.com/2010/10/25/avr-programming-02-the-hardware/ "Permanent Link to AVR Programming 02: The Hardware")
*   [AVR 编程 03:读取和编译代码](http://hackaday.com/2010/11/05/avr-programming-03-reading-and-compiling-code/ "Permanent Link to AVR Programming 03: Reading and compiling code")
*   [AVR 编程 04:写代码](http://hackaday.com/2010/11/19/avr-programming-04-writing-code-etc/)

## 方案

正如我以前说过的，如果你想把它放到芯片上，你必须有一个程序员。有大量的选择，但我将涵盖几个最简单和最便宜的。我们关注的是[系统内编程](http://en.wikipedia.org/wiki/In-system_programming) (ISP)，这意味着你可以在不从电路中移除芯片的情况下对芯片进行编程。

**DAPA Cable**

**![](../Images/d7f2d1cc2d02a355e432b99df6a3e5e5.png "dapa-cable")T2】**

直接 AVR 并行访问，或 DAPA 电缆，是一个非常简单和廉价的编程方法。你可以用几块钱的零件很快地造出一个，但是这种便利也带来了一些问题。首先是你的电脑上必须有并口；这是现代笔记本电脑和一些现代台式机所没有的。但是如果你周围有一台旧的个人电脑，这将让你立刻开始编程。

事实上，我做的第一个 AVR 原型就是用这种电缆制作的。直到我发现了另一个问题。这只会对低速芯片进行编程。如果你试图全速运行芯片的时钟(通过改变保险丝设置…更多内容在第 3 部分),你将无法再使用 DAPA 电缆与它对话。如果你做错了什么，也有可能损坏你的并行端口或者更糟。但是如果你想试试的话，这里是我如何建立我的。

[![](../Images/cd0f527a4d43e85c4fa54a46bb901a27.png "dapa-cable-construction")T2】](http://hackaday.com/wp-content/uploads/2010/10/dapa-cable-construction.jpg)

它使用 DB25 连接器连接到计算机。正如您在原理图中看到的，我在复位、SCK、MISO 和 MOSI 引脚上使用了 1 千欧姆电阻进行电流保护。我没有在接地引脚上使用电阻。我使用了一根带状电缆，将一端焊接到原理图中所示的五条信号线中的每一条上。在带状电缆的另一端，我使用了一个有六个插槽的连接器外壳，用空白填充其中一个插槽，以便我可以跟踪信号。这很容易插入引脚接头或连接到跳线，如上所示。回想起来，使用 2×3 IDC 连接器并使用 [AVR ISP 标准](http://hackaday.com/wp-content/uploads/2010/10/avr-isp-header.jpg)(来自[AVR:In-System Programming PDF](http://www.atmel.com/atmel/acrobat/doc0943.pdf))路由信号可能是更好的选择。如果你走这条路，你很有可能很快就会升级，所以不要为设计细节而苦恼。

Arduino

**![](../Images/c08eb1f431dee88d99e38e532c656676.png "arduino")
T3】**

作为一名程序员，我将忽略使用 Arduino。它们在嵌入式系统人群中无处不在，如果你还没有，你可以试着找个人把它们借给你一会儿。所有需要做的就是写一个 AVR 程序员草图到 Arduino 并进行编程连接。我们将在后面的文章中看看这个方法。

**USB tinyip**

**![](../Images/37b950f8ed8a35ceefe5ba043bf762df.png "USBtinyISP")
T3】**

[USBtinyISP](http://www.ladyada.net/make/usbtinyisp/index.html) 是一个基于 ATtiny2313 的系统内编程器，它使用 USB 连接(参见名称的来源？).对于你的第一个程序员来说，这是一个不错的选择。如果你对自己的技能有信心，你可以自己制作电路，并使用 DAPA 电缆将编程固件安装到芯片上。或者你可以直接从阿达水果公司买。但是，如果你认为你要认真对待 AVR 开发，你应该考虑支付额外的钱给专业程序员。

**职业程序员**

**![](../Images/eb21712d69b4b90411a5bc97e552c016.png "atmel-programmers")
T3】**

Ateml 程序员是黄金标准。它们提供了我们讨论过的其他硬件所没有的东西，即恢复被损坏的芯片的能力。如果你想使用复位引脚作为 I/O，你需要使用高压并行编程与你的芯片对话。即使你没有*决定*这样做，在某些时候你也会搞砸，你需要恢复一个进程，这有助于抵消专业程序员的额外成本。使用 Arduino 进行高压并行编程来恢复你的 AVR 是可能的，[但这本身就是另一个黑客](http://hackaday.com/2009/03/13/avr-hv-rescue-shield/)。

我们用 AVR 龙做几乎所有的事情。但是[STK 500](http://www.atmel.com/dyn/products/tools_card.asp?tool_id=2735)是一个非常受欢迎的板，尽管你需要一个串行端口来使用它。它有芯片插座、按钮和 led，用于板上原型制作。Dragon 保留了未被占用的插座空间，并使用 USB 连接。

如果你长期从事这项工作，这些选择中没有一个可以替代。

我们至少应该提到 MKII T1，这是一个程序员，它以与 USBtinyISP 相同的方式提供 ISP，但也提供 JTAG、调试线和其他一些功能。我们对这个单元没有经验，所以如果你想知道更多，你必须自己做研究。至于其他程序员，使用谷歌或查看这篇文章的评论，因为人们通常不喜欢保守他们首选程序员的秘密。

**引导程序**

bootloader 并不是真正的程序员，而是一种使用它的方法。引导装载程序是已经在你的微处理器上的一组代码。它处理将代码写入芯片存储器所需的基本输入和输出。坏消息是它们确实占用了编程空间，但是你不必买一个硬件程序员。

用引导装载程序对芯片编程超出了本教程的范围。但是学着做并不难。事实上，这就是无需单独的硬件程序员就可以对 Arduino 进行编程的方法。

## 设置我们的测试电路

说够了，让我们建点东西吧！我们需要四样东西:一个微控制器，给它供电的东西，给它编程的方法，以及让我们知道它在工作的东西。

**硬件:**

*   无焊试验板
*   跳线
*   ATmega168 微控制器
*   78L05 电压调节器
*   100uf 电解电容器
*   10uf 电解电容器
*   发光二极管
*   180 欧姆电阻(180 到 330 欧姆之间的任何电阻都可以)
*   程序员(我们将展示 DAPA 和 Arduino)

**我们在做什么**

简而言之，我们将闪烁 LED 作为我们的第一个嵌入式程序。这需要几个组件:电源、微控制器本身、LED 及其限流电阻。

电源由一个电压调节器组成，它接受 7v 以上的输入电压，并输出 5V 的恒定电压。为了正常工作，该电路需要两个滤波电容。电容器的作用就像是储存罐，吸收电源轨上的小波动，提供稳定的电源，以保持我们的微控制器安全和愉快。

作为输出，我们将使用 LED。我们必须包括一个电阻来限制软件点亮时的电流量。如果没有这个限流电阻，电流会以对 LED、微控制器或两者都不安全的水平流动。

**电路原理图**

[![](../Images/9633b4e3141be8dbabcbe9164646e097.png "m168-blink")T2】](http://hackaday.com/wp-content/uploads/2010/10/m168-blink.png)

以上是我们作为例子使用的电路。左侧是一个简单的 5v 调节器电路，使用一个 LM7805 线性调节器和两个滤波电容，用虚线框与其余部分隔开。如果你已经有了某种类型的 5v 稳压电源，那就省点时间用吧。

您可能还注意到，原理图中的芯片标记为 AVR-MEGA8。我们使用的 ATmega168 与 ATmega8 引脚兼容。这意味着您可以将一个引脚替换为另一个引脚，所有 28 个引脚都将在它们应该在的地方，因此这不会导致任何问题。

添加一些这里没有的组件是一个很好的做法。应该有两个 0.1 uF 的电容用于[去耦](http://en.wikipedia.org/wiki/Decoupling#Electronics)；它们过滤掉电源轨上的波动，称为噪声。一条在 VCC 和 GND 之间，另一条在 AVCC 和 AGND 之间(尽可能靠近引脚)。reset 引脚上还应该有一个上拉电阻，让极少量的 5V 电流流入该引脚。这是芯片浮动时意外复位(未连接，因此没有明确的 0 或 5V 值)。为了简单起见，我省略了这些部分，对于这个简单的项目来说，这应该不是问题。但是随着你的项目变得越来越复杂，忽视这些考虑会反过来伤害你。

**建立在试验板上的电路**

**![](../Images/5aa7b2d122557b5a03a608529b14a9d6.png "wiring1-avrTut-pt2")T2】**

我开始在试验板上添加电压调节器来构建电路。然后将接地引脚连接到试验板顶部的接地轨，将输出引脚连接到试验板的电压轨。我还添加了两根电线，最终将连接到 9V 电池的正极和负极。

请务必阅读您的电压调节器的数据手册(例如: [LM7805](http://www.fairchildsemi.com/ds/LM/LM7805.pdf) )，以确定哪条引线是输入、接地和输出。你的调节器可能看起来和我的不同，因为它们的包装不同。上图中，输入引线在左边，地在中间，输出引线在右边。

![](../Images/920408f610f2162bfd34c8252da5b120.png "wiring2-avrTut-pt2")

现在，我已经在稳压器的输入引脚和接地引脚之间添加了一个 100 uF 电容，在输出引脚和接地引脚之间添加了一个 10 uF 电容，从而完成了电源。请特别注意这些电容器，在每个电容器的外壳上，一根引线应标记为负极(带负号的带子)。在添加微控制器之前，最好用万用表检查电压输出。太多的果汁会破坏你的新芯片。

在检查以确保我有一个稳定的 5V 电源，然后断开电池，我添加了 ATmega168 微控制器到板。注意酒窝是指向左边的。这一点很重要，因为 DIP 封装的标准方向和引脚编号显示，引脚 1 现在位于左下角，让我们可以轻松找到所需的其他引脚。

电源和地也被连接到芯片上。针脚 7 (VCC)和针脚 20 (AVCC)已经连接到 5V。针脚 8 (GND)和针脚 22 (AGND)都已接地。

![](../Images/60aad27fa9d8044f69e8acc9d2c0e0e1.png "wiring3-avrTut-pt2")

最后一步是将 LED 连接到端口 d 上的输出 0。我们的原理图告诉我们，我们要将 LED 的正极引线连接到 ATmega168 上的引脚 2，负极引线应该连接到试验板上未被占用的一行(确保不要将其连接到引脚 1)。led 通常在塑料外壳的一侧有一个小凹口，用来表示器件的负极引脚。拼图的最后一块是使用我们的电阻将 LED 的负极连接到地。

在上面的图片中，我连接了一个 9V 的电池，但是没有任何反应。这是因为芯片上还没有让 LED 闪烁的固件。我们需要在下一步中解决这个问题。

## **编程我们的测试电路**

再次检查所有的连接，让我们准备对微控制器进行编程。

**连接到编程器**

为了对我们的芯片进行编程，您只需要建立六个连接:

*   电压
*   地面
*   主机输入从机输出(MISO)
*   主人赶走奴隶(MOSI)
*   重置(RST)
*   从属时钟(SCK)

对于任何使用系统内编程的程序员来说都是如此。我甚至在我的大多数电路中设计了一个标准化的 6 引脚接头，这样你就可以轻松地将你的编程器重新连接到电路板上，并在线更新固件。但在本例中，我们将仅使用一些跳线进行连接。有一点需要记住，编程时只能使用一个电压源。编程时应断开电路电源，或者不要连接编程器上的电压线。

**作为程序员连接 Arduino**

作为程序员使用你的 Arduino 是非常简单的。您首先要做的是打开 Arduino IDE，然后打开示例软件:ArduinoISP.pde(在 examples/ArduinoISP 文件夹中)。以正常方式将其刷新到您的 Arduino 中。现在按照[的指示瞄准试验板上的 AVR](http://arduino.cc/en/Tutorial/ArduinoISP)(页面底部)。**重要:**选择一个电源。也就是说，要么把 Arduino 板上的电压接到你的试验板上，要么把电池接到我们接好的电源上。两者都做有可能损坏你的硬件。

这是我接上后的样子。

![](../Images/c7adff5183cad793477cda74c8243fb7.png "arduino-ISP-programmer")

现在一切准备就绪，跳到下一节:用 AVRdude 刷新固件。

**使用 DAPA 线缆连接**

根据您构建 DAPA 电缆的方式，我们需要的五种连接应该很容易实现。请注意，DAPA 电缆没有电压连接。目标处理器在编程期间必须有自己的电源(就像我们在试验板上构建的电源)。这是我的 DAPA 电缆连接后的样子。

![](../Images/bd786095aa23fe5ccc6a1fdfb2990f25.png "DAPA-ISP-programmer")

如果你不确定需要做什么样的连接，回去比较 DAPA 电缆设计和电路原理图。匹配我们的五个连接:味噌，MOSI，RST，SCK 和 GND。

## 使用 AVRdude 刷新固件

如果您已经完成了本系列第 1 部分的作业，那么您应该已经安装了交叉编译器工具。首先，[下载固件包](https://github.com/szczys/had_AVRtut_2/archives/master)并在 shell 中或在命令提示符下导航到该目录。可以在 Linux 和 OSX 系统上使用以下命令对芯片进行编程。

Arduino 作为程序员:

```
avrdude -P usb -b 19200 -c avrisp -p m168 -U flash:w:main.hex
```

作为程序员的 DAPA:

```
avrdude -P /dev/parport0 -c dapa -p m168 -U flash:w:main.hex
```

AVR Dragon 作为程序员:

```
avrdude -P usb -c dragon_isp -p m168 -U flash:w:main.hex
```

USBtinyISP 作为程序员:

```
avrdude -P usb -c usbtiny -p m168 -U flash:w:main.hex
```

您可以通过运行以下命令获得 AVRdude 程序的帮助:

```
avrdude -h
```

这将打印出可用命令的列表，或者您可以阅读在线文档。 **Windows 用户将需要更改命令**的/dev/*部分以匹配您的连接。你会发现在线手册的[窗口页面对此特别有帮助。标准的 Windows 端口名称包括 com0、com1 等。对于串口和 lpt0，lpt1 等。对于并行端口。](http://www.nongnu.org/avrdude/user-manual/avrdude_19.html)

至于上述编程命令中使用的其他标志:

当作为 ISP 程序员使用 Arduino 时，您必须使用“-b”来指定速度。该值在 Arduino 草图中设置，默认情况下应为 19200。

你总是需要指定什么样的芯片连接到编程器。在这里，我为我们的 ATmega168 使用了'-p m168 '。键入以下命令，获取所有兼容微处理器的列表

```
avrdude -p ?
```

指定程序员也是如此。您可以将上面命令中的'-p '改为'-c ',以获得程序员列表。

我们使用的命令中的最后一个选项告诉程序员将文件“main.hex”写入闪存。命令的一部分用于许多事情，包括改变芯片上的熔丝位。我将在本系列的第 3 部分中讨论这一点。

## 排除故障

此时，您的 LED 应该会愉快地闪烁。那是什么？不是吗？是时候开始真正的学习了。这里有一个列表可以帮助你开始:

*   你成功给芯片编程了吗？你应该得到消息:“258 字节的闪存验证”和“avrdude 完成。谢谢大家。”
*   如果你在编程过程中出现错误，首先要检查以确保你的芯片有电。
*   使用'-v '代替' flash:w:main.hex '再次尝试编程命令。这将只是试图与芯片对话，而不是写入芯片，这在解决编程错误时非常方便
*   重新检查您的编程连接，以确保您将正确的信号连接到正确的引脚
*   请确保您在计算机上有正确的端口，并且您有权限使用该端口。Linux 用户可以尝试使用-v 标志作为 ROOT 与芯片对话，以发现是否存在权限问题。如果这样做有效，你需要将你的用户添加到有权访问编程器连接的端口的组中
*   如果你成功地编程了芯片，你应该重新检查你的硬件。LED 是不是装反了，妨碍了点亮？
*   去一趟谷歌，开始搜索…这通常在开发过程中发挥作用，所以不要难过。很多人已经经历了你现在遇到的麻烦，他们最终都挺过来了。

## 结论

你做到了，你的第一个嵌入式电路是活的！现在，它只会闪烁，让你知道一切都在工作。但下一次我们将讨论这是如何实现的，我们可以做些什么来改变它的行为，以及如何使用编译器将我们的代码更改转换为微控制器可以运行的文件。感谢您的阅读，我们将在下一期文章中再见。

跟着我

## **资源**

固件包:[包下载](https://github.com/szczys/had_AVRtut_2/archives/master)或 [Github 页面](https://github.com/szczys/had_AVRtut_2)

Atmel AVR [ATmega168 数据表](http://www.atmel.com/dyn/resources/prod_documents/doc2545.pdf) (PDF)

[AVR 老兄在线文档](http://www.nongnu.org/avrdude/user-manual/avrdude.html)

[AVR 在系统编程应用笔记](http://www.atmel.com/atmel/acrobat/doc0943.pdf) (PDF)

AVR ISP 编程标题:

![](../Images/d634bc8f4483d0b381903693eae364fb.png "avr-isp-header")