# 操作方法:读取联邦快递 Kinko 的智能卡(SLE4442)

> 原文：<https://hackaday.com/2008/11/25/how-to-read-a-fedex-kinkos-smart-card-sle4442/>

我们的钱包里塞满了包含隐藏信息的 SIM 卡和 RFID 卡。使用我们最新的项目[总线盗版通用串行接口](http://hackaday.com/2008/11/19/how-to-the-bus-pirate-universal-serial-interface/)，我们可以从许多普通智能卡中转储内存。在今天的操作指南中，我们将向您展示如何连接普通的[智能卡](http://en.wikipedia.org/wiki/Smart_card)，并带您浏览存储在[联邦快递 Kinko 的预付费储值卡](http://hackaday.com/2006/03/02/fedex-kinkos-smart-cards-hacked/)上的数据。

**背景**

联邦快递 Kinko 的预付卡实际上是一张 SLE4442 智能卡。关于 SLE4442 没有什么秘密，它完全记录在[数据表](http://www.smartcardsupply.com/PDF/DS_sle4432_42_0795.pdf) (PDF)中，你可以[在网上购买空白卡](http://www.smartcardworld.com/SLE4442.htm)。

这种卡是公开可读的，我们可以在没有任何恶意入侵的情况下看到里面的内容。它由一个三字节的密码保护，有一个“三振出局”的策略，在三次密码尝试失败后，该卡将失效。

由于它在 Kinko 和其他公司的广泛使用，SLE4442 已经成为几起高调黑客攻击的目标。在 06 年的 Toorcon 上，[bunnie]和[ [Chris Tarnovsky](http://hackaday.com/2008/05/31/silicon-hacking/) ]主持了一场关于卡片的讨论。[Chris]检查了硅芯片，并指出短路走线可能会破坏安全措施。你可以在 T2 的网站上看到骰子的高分辨率图像。[ [斯特罗姆·卡尔森](http://hackaday.com/author/stromcarlson/) ]直奔源头，[用逻辑分析仪](http://hackaday.com/2006/03/02/fedex-kinkos-smart-cards-hacked/)窥探密码，正如他著名的[’06 Defcon 演示](http://www.dc414.org/download/confs/defcon14/DC-14-Presentations/DC-14-Carlson/?C=M;O=A)中所记载的。这张卡片甚至出现在[作品](http://flickr.com/photos/hackaday/2259126114/)中。

我们不打算让[恶意入侵卡](http://www.setchief.com/ProductShow.asp?ID=83)，但我们仍然可以查看内容，并演示如何用我们的最新项目[总线盗版](http://hackaday.com/2008/11/19/how-to-the-bus-pirate-universal-serial-interface/)连接任意协议。

**连接到 SLE 4442
**

![sle4442-connection](img/ac445cf93b10355668c7bb3c48f0ecde.png "sle4442-connection")

| **引脚** | **功能** | **公交车盗销** |
| **1** | +5 伏 | +5v 电源 |
| **2** | 重置 | 去吧 |
| **3** | 时钟 | SCL |
| **4** | dota ai | 国家药品监督管理局 |
| **5** | 不适用 | – |
| **6** | 地面 | 地面 |

如果您还没有，请获取 [SLE4442 数据手册](http://www.smartcardsupply.com/PDF/DS_sle4432_42_0795.pdf) (PDF)。引脚排列如上图所示。如果您在确定卡的方向时遇到困难，请注意大的中心焊盘接地。

该卡需要 5 伏 DC(数据表第 27 页，表 3.2.2)，我们使用了总线盗版的方便的 5 伏电源。5 伏接口不成问题，因为总线盗版输入都是 5 伏容差。

使用双线接口，带有时钟线和双向数据线。我们将这些连接到总线盗版的 SDA 和 SCL 引脚。需要第三个信号 reset 来初始化芯片；我们用了总线盗版的辅助输出来控制复位线。我们可以用来与器件接口的最大时钟频率为 50kHz，规定的最小值为 7kHz(第 28 页，表 3.2.4:fCLK)。总线盗版的 raw 2 wire 协议运行在大约 5kHz，但我们没有遇到任何接口设备的问题。

![cct1](img/6c868973ccb05797adf3243641458dcc.png "cct1")

sle4442 具有[集电极开路输出](http://en.wikipedia.org/wiki/Open_collector)，并依靠上拉电阻来保持总线高电平。它不是在地和 5v 之间切换数据引脚，而是在地和[高阻抗](http://en.wikipedia.org/wiki/High_impedance)状态之间切换。高阻抗意味着芯片不在线路上施加任何状态，它让线路浮动，就像微控制器的输入引脚一样。

每条信号线需要用一个 2K 10K 的电阻上拉至 5v，这个值不是特别重要。如果没有上拉电阻，我们在总线上只能看到 0(地)，因为 sle4442 本身不会产生电压。这种技术的一个好处是，仅在 3.3 伏下切换的 Bus Pirate 将在满 5 伏下与 sle4442 通信，符合高电平的 3.5 伏最低电压要求(数据手册，第 27 页，表 3.2.3:Vih)。

**初始化卡** 

在我们从卡上读取数据之前，我们必须对它进行初始化。这是通过标准的 ISO 7816-3 应答复位(ATR)命令来完成的。初始化后，我们可以使用简单的双线协议从卡中读取数据。

*设置原始 2 线模式*

该界面与 I2C 共享一些特征，但不兼容。我们使用总线盗版的原始 2 线总线模式来连接设备。

> RAW2>m
> 1。SPI
> 2。I2C
> 3。UART
> 4。生丝 2
> 5。RAW 3 线
> 模式>4**<–RAW 2 线总线模式**
> 900 模式设置
> …
> 速度>1**<–速度设置在当前固件** 901 速度设置
> 1 中被忽略。高 Z 输出(H =输入，L=GND)
> 2。正常输出(H=Vcc，L=GND)
> 模式>1**<–高阻抗输出类型**
> 9xx 输出高 z
> 402 raw 2 线就绪，P 为上拉
> RAW2 >

总线盗版有板载上拉电阻，但它们只拉到 3.3v，我们必须使用外部上拉至 5v，如图所示。高 Z 输出模式与总线兼容，正常输出会在总线上施加 3.3 伏电压，可能会损坏某些东西。

> raw 2 > l**<–配置 MSB/LSB**T2 1。MSB 优先
> 2。LSB 优先
> 模式>2**<–LSB 优先**
> 9xx LSB:最小 SIG 位优先
> RAW2 >

该卡首先读写每个字节的最低有效位(数据手册第 10 页)。我们使用菜单选项 L 将数据模式设置为 LSB 优先。

*发送 7816-3 ISO 应答复位命令*  

![atr](img/bd941d7578e301ba1c88f20d1e11079f.png "atr")

ISO 7816-3“重置应答”是许多智能卡中使用的标准化命令。ATR 序列如上图所示:reset 保持高电平，发送一个时钟脉冲，reset 释放。接下来的 32 个时钟脉冲(4 字节)从卡上读取一个通用 ATR 报头。标头包含有关卡类型和协议的信息。多卡智能卡读卡器利用这一点来确定如何读取每张卡。

> raw2>@^arrrr**<–aux 高电平(highz)，时钟滴答，aux 低电平，读取 4 字节**
> 952 AUX 高电平 IMP，读取:1
> 4xx RAW2WIRE 0x01 时钟滴答
> 950 AUX 低电平
> 430 RAW2WIRE 读取:0x a2**<–begin ATR 头字节**
> 430 RAW2WIRE 读取:0x10
> 430 RAW2WIRE 读取:0x

我们向巴士海盗发出@^arrrr 命令。@将辅助引脚置于高阻抗输入模式，上拉电阻将复位保持在 5v。^发出一个有延迟的时钟脉冲。a 将辅助引脚返回到输出，并将复位线保持在地。

r 发出 8 个时钟脉冲，并将返回的位显示为一个字节。这是该议定书与 I2C 不相容的一个例子。I2C 在每个字节之间包含一个额外的应答位，sle4442 连续输出 32 位。

数据手册第 25 页解释了 ISO7816-3 接头。用二进制解释最简单。我们将总线盗版设置为二进制显示模式，并发出另一个 ATR 命令，而不是将所有内容都转换为二进制。

> raw 2 > o**<–设置输出模式**
> 1。六角
> 2。十二月
> 3 日。BIN
> 4。RAW
> 输出模式>3**<–显示二进制数**
> 903 输出模式设置
> raw 2>@^arrrr**<–另一个 ATR 命令**
> 952 AUX 高电平 IMP，read:1
> 4xx raw 2 wire 0b 0000001 时钟滴答
> 950 AUX 低电平
> 430 raw 2 wire read:0b 1000010【0

根据 ISO 7816-3(数据手册第 25 页)，前 2 个字节是协议报头字节。

字节 1 标识协议类型。

> 0b 10100010
> 7:4–协议类型(1010=2 线)
> 3:3–RFU(0)
> 2:0–结构标识符(010=通用)

如果我们没有数据手册，字节 2，协议参数，告诉我们关于卡的信息。

> 0b 00010011
> 7:7–支持随机读取长度(0=否，读取结束)
> 6:3–数据单元(0010 = 256 个单元)
> 2:0–数据单元位(011=每个单元 8 位)

从标题中我们可以看出，协议类型是 10，一个双线总线。在接受新的命令之前，卡片必须从头到尾读一遍。它有 8 位一个单位，256 个单位；总存储量为 256 字节。最后两个字节是 7814-4 数据，看起来没什么意思(参见数据表第 26 页)。

**转储主内存(256 字节)**

一旦卡被重置，ATR 字节被读取，我们就可以向卡发送命令。命令有三个字节长；它们以 I2C 式的[开始条件](http://www.esacademy.com/faq/i2c/busevents/i2cstast.htm)开始，以 I2C 式的停止条件结束。可以使用\-/_\和 _/-\手动生成开始和停止条件，但是 raw 2 wire library 还包括快捷键{和}。开始和停止条件与 I2C 相同，但它们在传输中的不同点使用。

读取主存储器命令是 *0x30* ，后面是一个读取起始地址( 0 ，以及第三个无关字节(0xff)。在停止条件之后，卡在每个时钟输出数据，直到它到达存储器的末端。如 ATR 报头所述，在卡到达存储器的最后一个字节之前，不能发送新的命令。从读取地址 0 开始，需要 256*8 个时钟脉冲来完成读取周期。

> raw 2 > {*0x 30*0【0x f】0r 255 0r 10**<
> 410 raw 2 wire 启动条件(\-/_ \)
> 420 raw 2 wire write:0x 30
> 0xFF 字节:**t52【255 字节批量读取】
> 0x 14【0x 2 0x 13 0x 10 0x 91 0x 46 0x 46 0x 0 0x 81 0x 15】
> 0x ff 0 0x 01 0x 4 0x 03 0x 00 0x 0 xff 0 xff 0 xff 0 xff
> 【0x F0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 15】
> 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00
> 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff
> 0x f 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff
> 0x f 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 0x 00 0x 00 0x 00 0x 00 0x 00
> 0x 00 0x 00 0x 00 0x 00 0x 43 0x 61 0x 73 0x 68
> 0x 20 0x 43 0x 43 0x 75 0x 73 0x 74 0x 6 F0 x 6 d0s 65
> 0x 72 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 31]0 0x 03 0x 00 0x 01 0x 00
> 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 38]0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 20
> 0x 08 0x 03 0x 04 0x 09 0x * * 0x * * 0x * * 0x * * 0x * 0x 00
> 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 0x 00 xff 0 xff
> 0x f 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff
> 0x f 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff
> 0x f 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff 0 xff****

{发出总线启动条件。0x30 发送读地址，0 是起始字节，0xff 可以是任何值。}发送停靠站条件。0r255 以 255 个 8 位字节计时，并将其显示在屏幕上。该卡实际上有 256 字节的主存储器，因此我们发出一个额外的读取命令来获取最后一个字节，并验证总线在读取结束后返回高电平。我们不能使用 0r256，因为总线盗版者不理解大于 255 的十进制数(我们应该解决这个问题)。

*数据是什么意思？*

我们根据数据手册、[Strom]的 Defcon 演示以及本指南对该卡进行了剖析。

*32 字节报头…*

> 0x a2 0x 13 0x 10 0x 91**<–前四个字节是 ATR 数据的重复**
> 0x 46 0x ff 0x 81 0x 15**<–制造商标签，其他垃圾**0x ff 0x 01 0x 4b 0x 03 0x 00**<–ICCF，IC 卡制作者 id**
> 0x ff 0x ff 0x ff 0x ff 0x ff**<–ICCN，IC 序列号，0**
> 0xFF 0xFF 0xFF 0xFF)
> 0x ff 0x ff 0x ff 0x ff 0x ff**<–所有其他字节 0**

前 32 个字节是永久刻录的报头，包含序列号、制造商代码和其它唯一数据(数据手册第 24 页)。即使您有一张空白卡和一个安全码，这个标题也可以防止复制卡。金科公司并没有在每张卡上永久地刻上一个定制的序列号。

现在数据…

> 0x7B 0x 14 0x AE 0x 47 0xe 1 0x7A 0x 94 0x3F**<–IEEE-754 值，$0.02**

这是以 IEEE-754 格式存储在卡上的值。您可以使用[这个实用程序](http://babbage.cs.qc.edu/IEEE-754/64bit.html)使其可读。0x3f 947 AE 147 AE 147 b = 0.02 美元。

> …8 个字节的垃圾…
> 0x20**<–复制后 0x 20，计算机时间后 0x 00**
> 0x 08 0x 03 0x 04 0x 09 0x * * 0x * * 0x * ***<–购买日期/时间**

这是购买该卡的日期和时间，2008 年 3 月 4 日，9:*:* *。**.为了保护我们供应商的匿名性，一些数字被隐藏了。

> …40 字节的垃圾…
> 0x 30 0x 31 0x 3 * 0x 3 ***<–店铺编号:01 * ***0x 30 0x 30 0x 31 0x 33 0x 3 * 0x 3 * 0x 3 ***–SN:0013 * * ***

卡序列号由商店号和一个唯一的七位数组成。一些数字模糊不清。

> …更多字节…
> 0x 08 0x 03 0x 04 0x 09 0x * * 0x * * 0x * ***<–另一次**
> …更多字节…
> 0x ff 0x ff 0x ff 0x ff 0x ff 0x 0x 0x 0x 0 0x 00**<–卡上最后 8 个字节**
> 0x ff 0x ff…**<-非真实数据字节**

**转储保护存储器(4 字节)**

数据存储器的前 32 个字节可以写保护。四字节数据保护寄存器(命令 0x34)的每一位代表一个字节的数据存储器。设置为 1 的位不能被覆盖。我们可以读取数据保护寄存器，并找出主存储器的哪些字节是写保护的。这在二进制中是最容易理解的，所以我们在二进制输出模式下做了这个操作。

> raw 2 > { 0x 34 0 } 0 R4**<–命令**
> 410 RAW2WIRE 启动条件(\-/_\)
> 420 RAW2WIRE 写:0b00110100
> 420 RAW2WIRE 写:0b00000000
> 420 RAW2WIRE 写:0b 000000
> 440 raw 2 wire 停止条件(_/\)
> 431 raw 2 wire 批量

每个位对应卡存储器的前 32 个字节中的一个。如果该位为 1，则相应的字节写保护。该寄存器可以被写入，但前提是你有正确的密码。

**转储安全存储器(4 字节)**

安全存储器包含一个密码验证尝试计数器和三字节密码。我们可以在没有密码的情况下读取安全存储器，但是密码字节将读取为 0。安全存储器地址是 0x31。

> raw 2 > { 0x 31 0 } 0 R4**<–命令**
> 410 RAW2WIRE 启动条件(\-/_\)
> 420 RAW2WIRE 写:0b00110001
> 420 RAW2WIRE 写:0b 0000000
> 420 raw 2 wire 写:0b 0000000
> 440 raw 2 wire 停止条件(_/\)
> 431 raw 2 wire 批量

尝试计数器从 3(0b 00000111)开始计数，并递减计数到 0。当计数器读数为 0 时，卡基本上被销毁。我们使用了两次访问尝试来测试密码命令，这张卡还有一次尝试。

**更进一步**

我们想展示这张卡的所有功能，包括密码验证和数据更新，但我们需要购买一张有已知安全代码的新卡。

由于有各种各样有趣的智能卡，给总线盗版添加一个 ISO 7816-3 ATR 命令宏和回复解码器可能会很方便。